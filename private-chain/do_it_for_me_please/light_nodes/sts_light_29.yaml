---
apiVersion: v1
kind: Namespace
metadata:
  name: light
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: da-light-29
    chain-id: private
    environment: private
    network: da
    type: light
  name: da-light-29
  namespace: light
spec:
  podManagementPolicy: OrderedReady
  replicas: 56
  revisionHistoryLimit: 10
  serviceName: da-light-29
  selector:
    matchLabels:
      app: da-light-29
      chain-id: private
      environment: private
      network: da
      type: light
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: da-light-29
        chain-id: private
        environment: private
        network: da
        type: light
    spec:
      containers:
        - command:
            - /home/celestia/start.sh
          env:
            #- name: CELESTIA_BOOTSTRAPPER
            #  value: "true"
            - name: GOLOG_LOG_FMT
              value: json
            - name: CELESTIA_HOME
              value: /home/celestia
            - name: CELESTIA_BIN_FOLDER
              value: /bin
            - name: CELESTIA_CUSTOM
              value: "private:CF5C1DC1A332B26B393ADD03EA2519F5C7BF6207573C35349C5E22DD17751747"
            - name: SETUP_PATH
              value: /tmp/celestia-config
                #- name: TRUSTED_PEERS
                #  valueFrom:
                #    configMapKeyRef:
                #      key: TRUSTED_PEERS
              #      name: trusted-peers
          image: ghcr.io/celestiaorg/celestia-node:v0.11.0-rc3
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 20
            successThreshold: 1
            tcpSocket:
              port: rest
            timeoutSeconds: 1
          name: da
          ports:
            - containerPort: 2121
              name: p2p
              protocol: TCP
            - containerPort: 6060
              name: something-1
              protocol: TCP
            - containerPort: 26658
              name: rpc
              protocol: TCP
            - containerPort: 26659
              name: rest
              protocol: TCP
            - containerPort: 8890
              name: libp2p-metrics
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: rest
            timeoutSeconds: 1
          resources:
           #limits:
            #  memory: 250Mi
            requests:
              cpu: "100m"
              memory: 200Mi
          securityContext:
            runAsGroup: 10001
            runAsUser: 10001
          volumeMounts:
            #- mountPath: /home/celestia/config
            #  name: da-config
            #- mountPath: /home/celestia/data
            #  name: da-data
            #  subPath: data
            #- mountPath: /home/celestia/blocks
            #  name: da-data
            #  subPath: blocks
            #- mountPath: /home/celestia/index
            #  name: da-data
            #  subPath: index
            #- mountPath: /home/celestia/transients
            #  name: da-data
            #  subPath: transients
            #- mountPath: /home/celestia/keys
            #  name: da-keys
            - mountPath: /home/celestia/start.sh
              name: start
              subPath: start.sh
            - mountPath: /tmp/celestia-config
              name: shared
      #- command:
      #  - /otelcol-contrib
      #  - --config=/conf/otel-agent.yaml
      #  image: otel/opentelemetry-collector-contrib:0.71.0
      #  imagePullPolicy: IfNotPresent
      #  name: otel-agent
      #  ports:
      #  - containerPort: 8888
      #    name: prometheus-otel
      #    protocol: TCP
      #  - containerPort: 9090
      #    name: prometheus
      #    protocol: TCP
      #  resources:
      #    limits:
      #      memory: 200Mi
      #    requests:
      #      cpu: 100m
      #      memory: 100Mi
      #  terminationMessagePath: /dev/termination-log
      #  terminationMessagePolicy: File
      #  volumeMounts:
      #  - mountPath: /conf/otel-agent.yaml
      #    name: otel-agent
      #    subPath: otel-agent.yaml
      dnsPolicy: ClusterFirst
        #initContainers:
        #- command:
        #  #- /setup/setup.sh
        #  - /setup/setup.sh
        #  env:
        #  - name: CELESTIA_BOOTSTRAPPER
        #    value: "true"
        #  - name: CONSENSUS_NODE_SERVICE
        #    value: consensus-full-1
        #  - name: CONSENSUS_NAMEPACE
        #    valueFrom:
        #      fieldRef:
        #        apiVersion: v1
        #        fieldPath: metadata.labels['consensus-namespace']
        #  - name: SETUP_PATH
        #    value: /tmp/celestia-config
        #  image: alpine:3.18.0
        #  imagePullPolicy: IfNotPresent
        #  name: da-setup
        #  resources:
        #    limits:
        #      memory: 500Mi
        #    requests:
        #      cpu: 300m
        #      memory: 250Mi
        #  terminationMessagePath: /dev/termination-log
        #  terminationMessagePolicy: File
        #  volumeMounts:
        #  - mountPath: /tmp/celestia-config
        #    name: shared
        #  - mountPath: /setup/setup.sh
        #    name: setup
        #    subPath: setup.sh
        #restartPolicy: Always
        #schedulerName: default-scheduler
        #securityContext:
        #  fsGroup: 10001
        #  fsGroupChangePolicy: OnRootMismatch
        #    #serviceAccount: da-sa-bridge-1
        #    #serviceAccountName: da-sa-bridge-1
      #terminationGracePeriodSeconds: 30
      volumes:
        #- configMap:
        #    defaultMode: 420
        #    name: otel-agent-bridge-1-gb2ct8d928
        #  name: otel-agent
        #- name: da-config
        #  persistentVolumeClaim:
        #    claimName: da-config-bridge-1
        #- name: da-data
        #  persistentVolumeClaim:
        #    claimName: da-data-bridge-1
        #- name: da-keys
        #  persistentVolumeClaim:
        #    claimName: da-keys-bridge-1
        - configMap:
            defaultMode: 0777
            name: start-light-29
          name: start
        - configMap:
            defaultMode: 360
            name: setup-light-29
          name: setup
        - emptyDir: {}
          name: shared
  updateStrategy:
    rollingUpdate:
      partition: 0
    type: RollingUpdate
---
apiVersion: v1
data:
  start.sh: |
    #!/bin/bash
    celestia light init --node.store=/home/celestia/
    sed -i "s|TrustedHash = \"\"|TrustedHash = \"CF5C1DC1A332B26B393ADD03EA2519F5C7BF6207573C35349C5E22DD17751747\"|g" /home/celestia/config.toml # consensus first hash
    # BN, FN, Bootstrapper
    sed -i 's|TrustedPeers = \[]|TrustedPeers = \["/ip4/192.168.11.173/tcp/2121/p2p/12D3KooWKPpiepLYUsErpTeaKhoE31D9YZNVFuvZ3SHQLR7RMiip","/ip4/192.168.26.206/tcp/2121/p2p/12D3KooWGP9hHcihg2QdA7PXfRedkXweqHxQH4w4WLSwBeT9eUDn","/ip4/192.168.53.90/tcp/2121/p2p/12D3KooWMGVqcAPLwoGdboGVPcGzg1mVDWRThHMjBwznQXckEcN4"]|g' /home/celestia/config.toml
    cat /home/celestia/config.toml
    celestia light start --core.ip=100.71.50.129 --node.store=/home/celestia/ --gateway --metrics --metrics.tls=false --p2p.metrics --p2p.network=private --metrics.endpoint=otel.celestia.observer:4318  --pyroscope --pyroscope.tracing --pyroscope.endpoint http://pyroscope.pyroscope.svc.cluster.local:4040
kind: ConfigMap
metadata:
  labels:
    app: da-light-29
    chain-id: light
    type: light
  name: start-light-29
  namespace: light
